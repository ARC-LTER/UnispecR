---
title: "Process LTER Unispec Data"
author: "Ruby An"
date: "December 17, 2018"
output:
  html_notebook:
    number_sections: yes
  html_document:
    df_print: paged
editor_options:
  chunk_output_type: console
---

# How to use this R Markdown Notebook: 

This R Markdown document walks through processing historic (already collected) unispec data from 2010-2018. 

# Required Packages
```{r setup, echo=F}
knitr::opts_chunk$set(echo = TRUE)

## Required Packages
library("tidyverse")
library("knitr")
source("unispec_functions.R") # file loads required functions

## Useful vectors for standardizing names and filtering data
WSG <- c("WSG1", "WSG23")
SHB <- c("SHB1", "SHB2")
HIST <- c("HST")
HTH <- c("DHT")
site_list <- list("MAT", "LMAT", "MNAT", "NANT", HTH, WSG, SHB, HIST)


## Treatment vectors
CT <- c("CT","CT1","CT2")
NP_gradient <- c("F0.5","F1","F2","F5","F10") # for LOF site
N_types <- c("NO3", "NH4") # for LOF site
trtmt_list <- list(CT, "N", "P", "NP", NP_gradient, N_types)

## Useful vectors for plotting
# Color sequences
pur_pal <- RColorBrewer::brewer.pal(5, "Purples")
```



# Load Data
Load historic unispec data (Jim Format).

```{r unispec_data}
df_clean <- read_rds("HistoricUnispecData/2016_unispec_dataframe_clean.rds")

```

# Check Spectral Data

## Plot Spectra: Site vs. Block
For the following code, make sure you select only one date per site. The 5 measurements per plot are averaged as a line and one standard deviation above and below shaded. Interactively edit the "PLOT SELECTION" vectors in the code chunk below to investigate specific data.


```{r plot_spectra_blocks, dependson="unispec_data"}
# Recall df_table for list of dates/sites
df_table <- df_clean %>% 
  select(Date, Site) %>% 
  distinct() %>% 
  group_by(Date) %>% 
  do(Sites = t(.[-1])) %>% 
  mutate(Sites = paste( unlist(Sites), collapse=','))
kable(df_table) 

#PLOT SUBSET -- SPECIFY SITE/DATE/ETC to ZOOM IN ON
check_dates <- ymd("2016-07-02", "2016-06-23")
check_sites <- c("MAT", "LMAT", "WSG")
check_blocks <- c("B1", "B2", "B3", "B4")
check_trtmts <- c("NP", CT) 

# Data Comparison Format
df_block <- df_clean %>% 
  filter(Date %in% check_dates) %>% 
  filter(Site %in% check_sites) %>% 
  filter(Block %in% check_blocks) %>% 
  filter(Treatment %in% check_trtmts) %>% 
  unnest(spu_spectra) %>% 
  group_by(Site, Block, Treatment, Date, Wavelength) %>% 
  summarize(
    avg_reflect = mean(Reflectance),
    max_ref = max(Reflectance),
    min_ref = min(Reflectance),
    sd_reflect = sd(Reflectance),
    n = n()
    ) 

ggplot(data = df_block, mapping = aes(x = Wavelength, y = avg_reflect)) +
  geom_line(aes(color=Treatment)) + 
  geom_ribbon(aes(ymin=avg_reflect-sd_reflect, ymax=avg_reflect+sd_reflect, fill=Treatment), alpha=0.25) +
  facet_grid(Date ~ Site + Block ) + 
  scale_color_manual(values=c("CT" = "forestgreen", "CT1"="darkolivegreen2", "CT2"="darkolivegreen3",
                              "N" = "dodgerblue", "NO3" = "skyblue", "NH4" = "deepskyblue",
                              "P" = "red2",
                              "NP" = pur_pal[5],
                              "F0.5" = pur_pal[1],
                              "F1" = pur_pal[2],
                              "F2" = pur_pal[3],
                              "F5" = pur_pal[4],
                              "F10" = pur_pal[5])) + 
  scale_fill_manual(values=c("CT" = "forestgreen", "CT1"="darkolivegreen2", "CT2"="darkolivegreen3",
                              "N" = "dodgerblue", "NO3" = "skyblue", "NH4" = "deepskyblue",
                              "P" = "red2",
                              "NP" = pur_pal[5],
                              "F0.5" = pur_pal[1],
                              "F1" = pur_pal[2],
                              "F2" = pur_pal[3],
                              "F5" = pur_pal[4],
                              "F10" = pur_pal[5]))

```


 
## Plot Spectra: Site vs. Date
Average plot averages by block. NOTE: Ask Laura what the correct error propogation is here.

```{r plot_spectra_dates, echo=F}
#PLOT SUBSET -- SPECIFY SITE/DATE/ETC to ZOOM IN ON
check_dates <- ymd("2016-06-18", "2016-06-23")
check_sites <- c("MAT", "LMAT")
check_blocks <- c("B1", "B2", "B3", "B4")
check_trtmts <- c("NP", CT, "N", "P") 

# Data Comparison Format
df_dates <- df_clean %>% 
  filter(Date %in% check_dates) %>% 
  filter(Site %in% check_sites) %>% 
  filter(Block %in% check_blocks) %>% 
  filter(Treatment %in% check_trtmts) %>%
  unnest(spu_spectra) %>% 
  group_by(Site, Block, Treatment, Date, Wavelength) %>% # average measurements by plot
  summarize(
    avg_reflect = mean(Reflectance),
    max_ref = max(Reflectance),
    min_ref = min(Reflectance),
    sd_reflect = sd(Reflectance)
    )  %>% 
  group_by(Site, Treatment, Date, Wavelength) %>% # average plots by block
  summarize(
    block_avg_reflect = mean(avg_reflect),
    max_ref = max(avg_reflect),
    min_ref = min(avg_reflect),
    sd_reflect = sd(avg_reflect)
    ) 

ggplot(data = df_dates, mapping = aes(x = Wavelength, y = block_avg_reflect)) +
  geom_line(aes(color=Treatment)) + 
  geom_ribbon(aes(ymin=block_avg_reflect-sd_reflect, ymax=block_avg_reflect+sd_reflect, fill=Treatment), alpha=0.25) +
  facet_grid(Site ~ Date) + 
  scale_color_manual(values=c("CT" = "forestgreen", "CT1"="darkolivegreen2", "CT2"="darkolivegreen3",
                              "N" = "dodgerblue", "NO3" = "skyblue", "NH4" = "deepskyblue",
                              "P" = "red2",
                              "NP" = pur_pal[5],
                              "F0.5" = pur_pal[1],
                              "F1" = pur_pal[2],
                              "F2" = pur_pal[3],
                              "F5" = pur_pal[4],
                              "F10" = pur_pal[5])) + 
  scale_fill_manual(values=c("CT" = "forestgreen", "CT1"="darkolivegreen2", "CT2"="darkolivegreen3",
                              "N" = "dodgerblue", "NO3" = "skyblue", "NH4" = "deepskyblue",
                              "P" = "red2",
                              "NP" = pur_pal[5],
                              "F0.5" = pur_pal[1],
                              "F1" = pur_pal[2],
                              "F2" = pur_pal[3],
                              "F5" = pur_pal[4],
                              "F10" = pur_pal[5]))

```


# Check Vegetation Indices

Currently, this only works for NDVI, EVI, and EVI2 as I haven't worked out spectral interpolation yet and the other indices need reflectance at a specific value (not a range). 

## Extract NDVI data
```{r convert_ndvi}
## Only NDVI data
ndvi_data <- df_clean %>%  # select just NDVI 
  unnest(multispec_indices) %>% 
  filter(Index == "NDVI(MODIS)") %>% 
  rename(NDVI = Value) 
```

## Plot NDVI: Site vs. Block
```{r ndvi, echo=F}
#PLOT SUBSET -- SPECIFY SITE/DATE/ETC to ZOOM IN ON
check_dates <- ndvi_data %>% select(Date) %>% unique() %>%  pull()#ymd("2017-06-08", "2017-06-15", "2017-06-26")
check_sites <- c("MAT")
check_blocks <- c("B1", "B2", "B3", "B4")
check_trtmts <- c("NP", "F10", CT) 

# ndvi_types <- df_tidy %>% # to calculate NDVI 
#   filter(Date %in% check_dates) %>% 
#   filter(Site %in% check_sites) %>% 
#   filter(Block %in% check_blocks) %>% 
#   filter(Treatment %in% check_trtmts) %>%
#   calculate_index(indices = "NDVI") # function in "unispec_functions.R"

ndvi_plot <- ndvi_data %>% 
  filter(Date %in% check_dates) %>%
  filter(Site %in% check_sites) %>%
  filter(Block %in% check_blocks) %>%
  filter(Treatment %in% check_trtmts) %>%
  group_by(Site, Block, Treatment, Date) %>% 
  summarise(
    avg_ndvi = mean(NDVI),
    sd_ndvi = sd(NDVI)
  ) %>% 
  group_by(Site,Treatment,Date) %>% 
  summarise(
    avg_ndvi = mean(avg_ndvi),
    sd_ndvi = sd(sd_ndvi)
  )

ndvi_subset <- ndvi_data %>% 
  filter(Date %in% check_dates)%>%
  filter(Site %in% check_sites) %>%
  filter(Block %in% check_blocks)%>%
  filter(Treatment %in% check_trtmts) %>% 
  group_by(Block)

ggplot(data = ndvi_subset, mapping = aes(x = Date, y = NDVI, color = Treatment)) +
  geom_point(aes(shape=Block), position = "jitter") + 
  geom_smooth(aes(fill=Treatment), method = lm, formula = y ~ splines::bs(x, 3)) + 
  facet_wrap(vars(Site)) + 
  scale_color_manual(values=c("CT" = "forestgreen", "CT1"="darkolivegreen2", "CT2"="darkolivegreen3",
                              "N" = "dodgerblue", "NO3" = "skyblue", "NH4" = "deepskyblue",
                              "P" = "red2",
                              "NP" = pur_pal[5],
                              "F0.5" = pur_pal[1],
                              "F1" = pur_pal[2],
                              "F2" = pur_pal[3],
                              "F5" = pur_pal[4],
                              "F10" = pur_pal[5])) +
    scale_fill_manual(values=c("CT" = "forestgreen", "CT1"="darkolivegreen2", "CT2"="darkolivegreen3",
                              "N" = "dodgerblue", "NO3" = "skyblue", "NH4" = "deepskyblue",
                              "P" = "red2",
                              "NP" = pur_pal[5],
                              "F0.5" = pur_pal[1],
                              "F1" = pur_pal[2],
                              "F2" = pur_pal[3],
                              "F5" = pur_pal[4],
                              "F10" = pur_pal[5])) 
  
  
plot_errorbar <- ggplot(data = ndvi_plot, mapping = aes(x = Date, y = avg_ndvi, color=Treatment, fill=Treatment)) +
  geom_point() +
  geom_line() + 
  geom_errorbar(aes(ymin = avg_ndvi-sd_ndvi, ymax= avg_ndvi + sd_ndvi), width=2) + 
  facet_wrap(vars(Site)) + 
  scale_color_manual(values=c("CT" = "forestgreen", "CT1"="darkolivegreen2", "CT2"="darkolivegreen3",
                              "N" = "dodgerblue", "NO3" = "skyblue", "NH4" = "deepskyblue",
                              "P" = "red2",
                              "NP" = pur_pal[5],
                              "F0.5" = pur_pal[1],
                              "F1" = pur_pal[2],
                              "F2" = pur_pal[3],
                              "F5" = pur_pal[4],
                              "F10" = pur_pal[5])) 
```


# Compare Raw|Correct NDVI

## Calculate Indices from Spectra
```{r df_ndvi}
# build tibble of #band_defns: instrument, color, min, max
band_defns <- tribble(
  ~definition, ~color, ~min, ~max,
  "ITEX", "red", 560, 600,
  "ITEX", "nir", 725, 1000,
  "MODIS", "red", 620, 670, 
  "MODIS", "nir", 841, 876,
  "MODIS", "blue", 459,479,
  "SKYE", "red", 620, 680,
  "SKYE", "nir", 830, 880,
  "SKYE", "blue", 455, 480,
  "ToolikGIS_Drone_2018", "red", 640, 680,
  "ToolikGIS_Drone_2018", "nir", 820, 890
)

ndvi_from_spectra <- clean_unispec_dataframe %>% 
  filter(!str_detect(Treatment, "REF")) %>% 
  mutate(spu_indices = map(spu_spectra, function(x) calculate_indices(x, band_defns = band_defns, instrument = "MODIS", indices = "NDVI")))

df_ndvi  <- ndvi_from_spectra %>% 
  # mutate(multispec_indices = map(multispec_indices, function(x) filter(x, Index=="NDVI(MODIS)"))) %>% 
  unnest(spu_indices) %>% 
  mutate(Index = str_c(Index, "_raw")) %>% 
  unnest(multispec_indices) %>% 
  mutate(Index1 = str_c(Index1, "_corrected")) %>% 
  gather(key = temp, value = Index, Index, Index1) %>% # combine indices into one column 
  gather(key = temp, value = Value, Value, Value1) %>% 
  select(-temp) 

```

## Plot NDVI w/Errorbars 
```{r ndvi_comp}

#PLOT SUBSET -- SPECIFY SITE/DATE/ETC to ZOOM IN ON
check_dates <- df_ndvi %>% select(Date) %>% unique() %>%  pull()#ymd("2017-06-08", "2017-06-15", "2017-06-26")
check_sites <- c("MAT", "LMAT", "HIST")
check_blocks <- c("B1", "B2", "B3", "B4")
check_trtmts <- c(CT, "NP") 


df_ndvi_subset <- df_ndvi %>% 
  filter(Date %in% check_dates)%>%
  filter(Site %in% check_sites) %>%
  filter(Block %in% check_blocks)%>%
  filter(Treatment %in% check_trtmts) %>% 
  filter(str_detect(Index, "NDVI"))
  
df_ndvi_summary <- df_ndvi_subset %>% 
  ## optional: group CT plots
  mutate(Treatment = replace(Treatment, Treatment %in% CT, "CT")) %>%  
  ## average data
  group_by(Site, Block, Treatment, Date, Index) %>% 
  summarise(
    avg_ndvi = mean(Value),
    sd_ndvi = sd(Value)
  ) %>% 
  group_by(Site,Treatment,Date,Index) %>% 
  summarise(
    avg_ndvi = mean(avg_ndvi),
    sd_ndvi = sd(sd_ndvi)
  ) 

ggplot(data = df_ndvi_summary, mapping = aes(x = Date, y = avg_ndvi, color=Index)) +
  geom_point() +
  geom_line() + 
  geom_errorbar(aes(ymin = avg_ndvi-sd_ndvi, ymax= avg_ndvi + sd_ndvi)) +
  facet_grid(Treatment ~ Site) 

```

